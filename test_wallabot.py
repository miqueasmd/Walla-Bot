import json
import subprocess
import time
import glob
import pandas as pd
import os

CONFIG_FILE = 'config.json'
CSV_PATTERN = 'wallapop_results_*.csv'

# List of test values for max_results
max_results_list = [10, 30, 80, 200, 500, 1000]

# Save the original config to restore it later
with open(CONFIG_FILE, 'r', encoding='utf-8') as f:
    original_config = json.load(f)

try:
    for max_results in max_results_list:
        print(f"\n--- Test with max_results = {max_results} ---")
        # Modify config: set max_results, disable image download and email for faster tests
        config = original_config.copy()
        config['max_results'] = max_results
        config['save_images'] = False
        config['send_email'] = False
        with open(CONFIG_FILE, 'w', encoding='utf-8') as f:
            json.dump(config, f, indent=4)
        # Run the bot script
        # This will create a new CSV file with the results
        subprocess.run(['python', 'walla-bot.py'], check=True)
        time.sleep(2)  # Wait a bit to ensure the file is written
        # Find the most recent CSV file generated by the bot
        csv_files = sorted(glob.glob(CSV_PATTERN), key=os.path.getmtime, reverse=True)
        if csv_files:
            latest_csv = csv_files[0]
            # Read the CSV and count the number of results
            df = pd.read_csv(latest_csv)
            print(f"Results obtained: {len(df)} (file: {latest_csv})")
        else:
            print("No results CSV file found.")
finally:
    # Restore the original config file
    with open(CONFIG_FILE, 'w', encoding='utf-8') as f:
        json.dump(original_config, f, indent=4)
    print("\nConfig restored to original values.") 